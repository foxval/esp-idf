#include <stdlib.h>
#include <stdint.h>
#include <rom/bigint.h>
#include "unity.h"

/* Note: These are really just sanity checks, mbedTLS tests do most of the testing of the
   RSA/bignum peripheral
*/

typedef struct {
    size_t num_words;
    uint32_t x[128];
    uint32_t y[128];
    uint32_t z[128];
} mul_op_t;

typedef struct {
    size_t num_words;
    uint32_t x[128];
    uint32_t y[128];
    uint32_t m[128];
    uint32_t rb[128];
    uint32_t mprime;
    uint32_t z_mm[128];
    uint32_t z_mexp[128];
} mod_op_t;

/* Z = X * Y */
static const mul_op_t multiplications[] = {
    {
        .num_words = 8,
        .x = { 0xaaaaaaaa, 0xaaaaaaaa, 0xaaaaaaaa, 0xaaaaaaaa, 0xaaaaaaaa, 0x0aaaaaaa, }, // 6 words
        .y = { 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0x0000bbbb, 
        }, // 8 words
        .z = { 0x2d82d82e, 0xd82d82d8, 0x82d82d82, 0x2d82d82d, 0xd82d82d8, 0xa2d82d82, 0xaaaaaaaa, 0xd27caaaa, 
               0x27d27d27, 0x7d27d27d, 0xd27d27d2, 0x27d27d27, 0x7d27d27d, 0x000007d2, }, // 14 words
    },
    {
        .num_words = 2,
        .x = { 0x90809342, 0x00000002, }, // 2 words
        .y = { 0x00000009, }, // 1 words
        .z = { 0x14852d52, 0x00000017, }, // 2 words
    },
    {
        .num_words = 32,
        .x = { 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 
               0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 
               0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 
               0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0x00000aac, 
        }, // 32 words
        .y = { 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x33455555, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x00000003, }, // 18 words
        .z = { 0xbbbbbbbc, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 
               0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xd6fbbbbb, 0x0a3d70a3, 0x3d70a3d7, 0x70a3d70a, 0xa3d70a3d, 
               0xd70a3d70, 0x66666663, 0x66666666, 0x66666666, 0x66666666, 0x66666666, 0x66666666, 0x66666666, 
               0x66666666, 0x66666666, 0x66666666, 0x66666666, 0x66666666, 0x66666666, 0x66666666, 0x555551c6,
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0xb7555555, 0xc28f5c29, 0x8f5c28f5, 0x5c28f5c2, 0x28f5c28f, 0xf5c28f5c, 
               0x00002228, }, // 49 words
    },
};

TEST_CASE("ROM bigint multiplication", "[esp32c]")
{
    const size_t num_cases = sizeof(multiplications)/sizeof(mul_op_t);
    printf("Testing %d multiplication cases...\n", num_cases);
    for (int i = 0; i < num_cases; i++) {
        const mul_op_t *c = &multiplications[i];
        uint32_t res[128];
        TEST_ASSERT(c->num_words <= 128);

        ets_bigint_enable();

        printf("Case %d...\n", i);
        int r = ets_bigint_multiply(c->x, c->y, c->num_words);
        TEST_ASSERT_EQUAL(0, r);

        ets_bigint_wait_finish();
        r = ets_bigint_getz(res, c->num_words);
        TEST_ASSERT_EQUAL(0, r);

        ets_bigint_disable();

        TEST_ASSERT_EQUAL_HEX32_ARRAY(c->z, res, c->num_words);
    }
}

const static mod_op_t mod_ops[] = {
    {
        .num_words = 1,
        .x = { 0x000abcde, }, // 1 words
        .y = { 0x00000001, }, // 1 words
        .m = { 0x000fffff, }, // 1 words
        .rb = { 0x00000010, }, // 1 words
        .mprime = 0x00100001,
        .z_mm = { 0x000abcde, }, // 1 words
        .z_mexp = { 0x000abcde, }, // 1 words
    },
    {
        .num_words = 10,
        .x = { 0xaaaaaaaa, 0xaaaaaaaa, 0xaaaaaaaa, 0xaaaaaaaa, 0xaaaaaaaa, 0x0aaaaaaa, }, // 6 words
        .y = { 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0xbbbbbbbb, 0x0000bbbb, 
        }, // 8 words
        .m = { 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x00000003, }, // 10 words
        .rb =  { 0x00000000, 0x01000000, }, // 2 words
        .mprime = 0x00000005,
        .z_mm = { 0x88888889, 0x88888888, 0x88888888, 0x88888888, 0x0b60b688, 0xd60b60b6, 0xdddddddd, 0x05afdddd, 
                  0x5b05b05b, }, // 9 words
        .z_mexp = { 0x0aa78ced, 0x9cdda8d6, 0x795158a3, 0xe1004e70, 0x81b91253, 0x78fd5d87, 0x98d758fe, 0x3fb5d9c5, 
                    0x236cee68, 0x00000002, }, // 10 words
    },
    {
        .num_words = 2,
        .x = { 0x90809342, 0x00000002, }, // 2 words
        .y = { 0x00000009, }, // 1 words
        .m = { 0x00000003, }, // 1 words
        .rb = { 0x00000001, }, // 1 words
        .mprime = 0x55555555,
        .z_mm = { }, // 0 words
        .z_mexp = { 0x00000001, }, // 1 words
    },
    {
        .num_words = 32,
        .x = { 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 
               0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 
               0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 
               0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0xcccccccc, 0x00000aac, 
        }, // 32 words
        .y = { 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x33455555, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x00000003, }, // 18 words
        .m = { 0x33333331, 0x55543333, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0xb5555555, 0xbbbbbbbb, 0xbbbbbbbb, 0x00000bbb, }, // 12 words
        .rb = { 0x89b83182, 0xb09b5089, 0x9b0fe007, 0xfeaef8eb, 0x51de6800, 0x21b24dea, 0x1418d59d, 0x209f870f, 
                0xbd3dfcfa, 0xd4613722, 0xf663ac1f, 0x0000020e, }, // 12 words
        .mprime = 0xa2e8ba2f,
        .z_mm = { 0xeb2b9e09, 0x8fed6494, 0xd256ca74, 0x78ee13a6, 0x01098e9c, 0x9e22119e, 0xc84f9d91, 0x9db0bebb, 
                  0xb402ecf6, 0x11ab3989, 0x29f4f53c, 0x0000000c, }, // 12 words
        .z_mexp = { 0xdb7e0188, 0x2dfccfb3, 0xba122c43, 0xb6c2c03d, 0x438de71c, 0xb45cbfa1, 0xb5965dd8, 0xd052d36d, 
                    0xe6cc0ead, 0xb375a7be, 0x9d543d3b, 0x00000822, }, // 12 words
    },
    {
        .num_words = 128,
        .x = { 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
               0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 0xabadacae, 
        }, // 128 words
        .y = { 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 
               0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 
               0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 
               0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 
               0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 
               0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 
               0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 0x22222222, 
               0x22222222, 0x22222222, 0x22222222, 0x33333222, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 0x33333333, 
               0x33333333, 0x33333333, 0x00033333, }, // 123 words
        .m = { 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 0x55555555, 
               0x55555555, 0x55555555, 0x00055555, }, // 123 words
        .rb = { 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 
                0x00000000, 0x00000000, 0x01000000, }, // 11 words
        .mprime = 0x00000003,
        .z_mm = { 0x0e62fe84, 0x0e62fe84, 0x0e62fe84, 0x0e62fe84, 0x0e62fe84, 0xeebbde84, 0xeebbddcc, 0xeebbddcc, 
                  0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 
                  0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 
                  0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 
                  0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 
                  0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 
                  0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 
                  0xeebbddcc, 0xeebbddcc, 0xeebbddcc, 0xcf14bdcc, 0xcf14bd15, 0xcf14bd15, 0xcf14bd15, 0xcf14bd15, 
                  0x4114bd15, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 
                  0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 
                  0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 
                  0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 
                  0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 
                  0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 
                  0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 0x41202f10, 
                  0x41202f10, 0x41202f10, 0x00002f10, }, // 123 words
        .z_mexp = { 0xc317a199, 0x8c22753d, 0x21b92bdc, 0x30c4dab8, 0xef524fb7, 0x1a14b561, 0x01c34e86, 0xb12571ef, 
                    0x1cc36f06, 0x11c9a489, 0x9b9a5463, 0xd6a5a090, 0xd4ddc3ab, 0x918ad2fd, 0xb35bdc9d, 0x437d7957, 
                    0x9f398556, 0xdc652db7, 0xfe6a6f8a, 0x4e847fff, 0x48323059, 0x12db9ce4, 0x252b2e54, 0xe4ddfaff, 
                    0x208df010, 0x839afbcd, 0xbf36d136, 0xb562d468, 0xe8792c16, 0xdf437ae7, 0x95fcda86, 0x9420bb50, 
                    0x59df744c, 0xae874be9, 0x02808c9d, 0xffc4c5ae, 0x082998e0, 0x986eee89, 0x92454dc5, 0x2c1f4404, 
                    0x6cd244eb, 0x79e6cec5, 0x1049f9d1, 0x0cf5fe53, 0x9e0d36c8, 0xd2e64586, 0xf42a199c, 0xae5734db, 
                    0xd549c59f, 0x8b8ef5f4, 0x519eccd4, 0xffc2c831, 0x4af9b41c, 0xcc32f895, 0x35f32dd3, 0x2accd61f, 
                    0x6d2ee64b, 0xdddcf89e, 0x0574092f, 0x568ababa, 0xb8b32c2f, 0xc8c49443, 0xac46a673, 0xdf514703, 
                    0x087c70d2, 0x000cdebc, 0x448be747, 0xf4a10c5c, 0x24c2370b, 0xe6f12f43, 0x46693240, 0xa891ec01, 
                    0xfa750d95, 0x488d9d64, 0x7cfcdbc6, 0xa07e8a20, 0x723746b3, 0x7aa53a89, 0xe93b492b, 0x2779178e, 
                    0xe8c2f2b7, 0x618a2ad0, 0x5342b66e, 0x824b8598, 0xf3413b4a, 0x76829c6e, 0x46329ae4, 0xb894bbf7, 
                    0x6b9f6eb7, 0x0383c410, 0x196b4509, 0x58a920fa, 0x87c7450b, 0x840c1ab8, 0xa70fbeeb, 0xecb1aad2, 
                    0x555b22d9, 0x0fc14e11, 0x44c1a3b3, 0xeb5e162a, 0x9e3132bd, 0xe5f5783b, 0x5143a0c6, 0x38c34c0a, 
                    0xffb2c4db, 0x9773fe69, 0x4ac83c4f, 0xcc94d100, 0x26eae0c2, 0x2bbf4ea4, 0x405ec355, 0x621ecae0, 
                    0xa601b7d7, 0xc77b63ac, 0xb4b7cd08, 0x499f7eb7, 0xe3fbdff1, 0xc7577d98, 0xfaed1c5e, 0x324b6548, 
                    0x6b9cb178, 0x234e08ec, 0x00028ad9, }, // 123 words
    },
};

TEST_CASE("ROM bigint modmult", "[esp32c]")
{
    const size_t num_cases = sizeof(mod_ops)/sizeof(mod_op_t);
    printf("Testing %d modular multiplication cases...\n", num_cases);
    for (int i = 0; i < num_cases; i++) {
        const mod_op_t *c = &mod_ops[i];
        uint32_t res[128];
        TEST_ASSERT(c->num_words <= 128);

        ets_bigint_enable();

        printf("Case %d...\n", i);
        int r = ets_bigint_modmult(c->x, c->y, c->m, c->mprime, c->rb, c->num_words);
        TEST_ASSERT_EQUAL(0, r);

        ets_bigint_wait_finish();
        r = ets_bigint_getz(res, c->num_words);
        TEST_ASSERT_EQUAL(0, r);

        TEST_ASSERT_EQUAL_HEX32_ARRAY(c->z_mm, res, c->num_words);

        ets_bigint_disable();
    }
}

TEST_CASE("ROM bigint modexp", "[esp32c]")
{
    const size_t num_cases = sizeof(mod_ops)/sizeof(mod_op_t);
    printf("Testing %d modular exponentiation cases...\n", num_cases);
    for (int i = 0; i < num_cases; i++) {
        const mod_op_t *c = &mod_ops[i];
        uint32_t res_ct[128], res_nct[128];
        TEST_ASSERT(c->num_words <= 128);

        ets_bigint_enable();

        printf("Case %d (%d words)...\n", i, c->num_words);
        int r = ets_bigint_modexp(c->x, c->y, c->m, c->mprime, c->rb, true, c->num_words);
        TEST_ASSERT_EQUAL(0, r);

        ets_bigint_wait_finish();
        r = ets_bigint_getz(res_ct, c->num_words);
        TEST_ASSERT_EQUAL(0, r);

        r = ets_bigint_modexp(c->x, c->y, c->m, c->mprime, c->rb, false, c->num_words);
        TEST_ASSERT_EQUAL(0, r);

        ets_bigint_wait_finish();
        r = ets_bigint_getz(res_nct, c->num_words);
        TEST_ASSERT_EQUAL(0, r);

        TEST_ASSERT_EQUAL_HEX32_ARRAY(c->z_mexp, res_ct, c->num_words);
        TEST_ASSERT_EQUAL_HEX32_ARRAY(c->z_mexp, res_nct, c->num_words);

        ets_bigint_disable();
    }
}
